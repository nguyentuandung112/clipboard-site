<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý tài khoản & Clipboard (Realtime)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Quản lý Tài khoản</h1>

  <!-- Tác vụ 1: Dán clipboard -->
  <textarea id="pasteArea" rows="6" cols="60" placeholder="Dán nội dung tài khoản ở đây..."></textarea>
  <br>
  <button onclick="exportClipboardContent()">📤 Xuất TXT từ nội dung đã dán</button>
  <div id="clipboardResult" style="margin-top:10px;"></div>
  <button onclick="pasteFromClipboard()">📋 Dán từ Clipboard</button>

  <!-- Upload TXT -->
  <input type="file" id="txtUpload">

  <!-- Hiển thị tài khoản ngẫu nhiên -->
  <div id="accountDisplay">
    <div>Tên đăng nhập: <span id="lastUsername"></span> <button onclick="copyLast('lastUsername')">Copy</button></div>
    <div>Mật khẩu: <span id="lastPassword"></span> <button onclick="copyLast('lastPassword')">Copy</button></div>
    <div>Email: <span id="lastEmail"></span> <button onclick="copyLast('lastEmail')">Copy</button></div>
    <div>Mật khẩu Email: <span id="lastEmailPass"></span> <button onclick="copyLast('lastEmailPass')">Copy</button></div>
  </div>

  <!-- Thông tin ID Apple -->
  <h3>ID Apple dùng chung</h3>
  <input id="inputIdApple" placeholder="ID Apple">
  <input id="inputIdApplePass" placeholder="Mật khẩu ID Apple">
  <button onclick="updateIdAppleForAll()">Lưu ID Apple</button>
  <button onclick="clearIdApple()">Xoá ID Apple</button>
  <div>ID Apple: <span id="displayIdApple">-</span> <button onclick="copyText('displayIdApple')">Copy</button></div>
  <div>Mật khẩu ID Apple: <span id="displayIdApplePass">-</span> <button onclick="copyText('displayIdApplePass')">Copy</button></div>

  <!-- Xoá toàn bộ -->
  <button onclick="deleteAllAccounts()">🗑️ Xoá toàn bộ dữ liệu</button>

  <!-- Firebase Config + Script -->
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7abH9ttrzdGHEs3UoRKnrNKamO-s8K9Q",
    authDomain: "hoangcoka123-7bb54.firebaseapp.com",
    projectId: "hoangcoka123-7bb54",
    storageBucket: "hoangcoka123-7bb54.appspot.com",
    messagingSenderId: "615010120621",
    appId: "1:615010120621:web:3c55dcbf857d4e826f2724"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let accounts = {};
  let filterCopied = false;

  function parseLine(line) {
    return line.includes(':') ? line.split(':') : line.includes('|') ? line.split('|') : line.trim().split(/\s+/);
  }

  document.getElementById("txtUpload").addEventListener("change", function(e) {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = e => {
      const lines = e.target.result.trim().split("\n");
      db.ref("accounts").once("value", snap => {
        const existing = snap.val() || {};
        const existingKeys = new Set(Object.values(existing).map(acc => `${acc.username}|${acc.password}|${acc.email}`));
        let addedCount = 0;
        lines.forEach(line => {
          const p = parseLine(line);
          const key = `${p[0]}|${p[1]}|${p[2]}`;
          if (p.length >= 4 && !existingKeys.has(key)) {
            db.ref("accounts").push({
              username: p[0], password: p[1], email: p[2], emailPass: p[3], copied: false
            });
            addedCount++;
          }
        });
        alert(`✅ Đã nhập từ TXT thành công!\nTổng số dòng đã thêm: ${addedCount}`);
        filterCopied = false;
        setTimeout(() => {
          renderAccounts();
          updateStats();
        }, 1000);
      });
    };
    r.readAsText(f);
  });

  function renderAccounts() {
    const unused = Object.entries(accounts).filter(([_, acc]) => !acc.copied);
    const random = unused[Math.floor(Math.random() * unused.length)];
    if (!random) return;
    const acc = random[1];
    document.getElementById("lastUsername").textContent = acc.username;
    document.getElementById("lastPassword").textContent = acc.password;
    document.getElementById("lastEmail").textContent = acc.email;
    document.getElementById("lastEmailPass").textContent = acc.emailPass;
  }

  function exportClipboardContent() {
  const content = document.getElementById("pasteArea").value;
  const blob = new Blob([content], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clipboard_export.txt";
  a.click();
}

function updateStats() {
    const all = Object.values(accounts);
    const used = all.filter(a => a.copied).length;
    const unused = all.length - used;
    console.log(`📊 Đã dùng: ${used}, Chưa dùng: ${unused}`);
  }

  db.ref("accounts").on("value", snap => {
    accounts = snap.val() || {};
    if (!filterCopied) renderAccounts();
    updateStats();
  });
  fetchGlobalIdApple();

  function pasteFromClipboard() {
    document.getElementById("clipboardResult").innerText = "";
    navigator.clipboard.readText().then(text => {
      const lines = text.trim().split("\n");
      document.getElementById("pasteArea").value = text;
      db.ref("accounts").once("value", snap => {
        const existing = snap.val() || {};
        const existingKeys = new Set(Object.values(existing).map(acc => `${acc.username}|${acc.password}|${acc.email}`));
        let addedCount = 0;
        lines.forEach(line => {
          const p = parseLine(line);
          const key = `${p[0]}|${p[1]}|${p[2]}`;
          if (p.length >= 4 && !existingKeys.has(key)) {
            db.ref("accounts").push({
              username: p[0], password: p[1], email: p[2], emailPass: p[3], copied: false
            });
            addedCount++;
          }
        });
        document.getElementById("clipboardResult").innerText = `✅ Đã dán từ Clipboard thành công!
Tổng số dòng đã thêm: ${addedCount}`;
        filterCopied = false;
        setTimeout(() => {
          renderAccounts();
          updateStats();
        }, 1000);
      });
    });
  }
  </script>
<!-- Hiển thị thống kê ngay trên trang -->
  <div style="margin-top:20px">
    <strong>📊 Thống kê:</strong>
    <span id="usedCount">Đã dùng: 0</span> | <span id="unusedCount">Chưa dùng: 0</span>
  </div>

  <script>
    function updateStats() {
      const all = Object.values(accounts);
      const used = all.filter(a => a.copied).length;
      const unused = all.length - used;
      document.getElementById("usedCount").textContent = `Đã dùng: ${used}`;
      document.getElementById("unusedCount").textContent = `Chưa dùng: ${unused}`;
      console.log(`📊 Đã dùng: ${used}, Chưa dùng: ${unused}`);
    }
  </script>
</body>
</html>
