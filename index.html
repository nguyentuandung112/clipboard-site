<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quáº£n lÃ½ tÃ i khoáº£n & Clipboard (Realtime)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Quáº£n lÃ½ TÃ i khoáº£n</h1>

  <!-- TÃ¡c vá»¥ 1: DÃ¡n clipboard -->
  <textarea id="pasteArea" rows="6" cols="60" placeholder="DÃ¡n ná»™i dung tÃ i khoáº£n á»Ÿ Ä‘Ã¢y..."></textarea>
  <br>
  <button onclick="exportClipboardContent()">ğŸ“¤ Xuáº¥t TXT tá»« ná»™i dung Ä‘Ã£ dÃ¡n</button>
  <div id="clipboardResult" style="margin-top:10px;"></div>
  <button onclick="pasteFromClipboard()">ğŸ“‹ DÃ¡n tá»« Clipboard</button>

  <!-- Upload TXT -->
  <input type="file" id="txtUpload">

  <!-- Hiá»ƒn thá»‹ tÃ i khoáº£n ngáº«u nhiÃªn -->
  <div id="accountDisplay">
    <div>TÃªn Ä‘Äƒng nháº­p: <span id="lastUsername"></span> <button onclick="copyLast('lastUsername')">Copy</button></div>
    <div>Máº­t kháº©u: <span id="lastPassword"></span> <button onclick="copyLast('lastPassword')">Copy</button></div>
    <div>Email: <span id="lastEmail"></span> <button onclick="copyLast('lastEmail')">Copy</button></div>
    <div>Máº­t kháº©u Email: <span id="lastEmailPass"></span> <button onclick="copyLast('lastEmailPass')">Copy</button></div>
  </div>

  <!-- ThÃ´ng tin ID Apple -->
  <h3>ID Apple dÃ¹ng chung</h3>
  <input id="inputIdApple" placeholder="ID Apple">
  <input id="inputIdApplePass" placeholder="Máº­t kháº©u ID Apple">
  <button onclick="updateIdAppleForAll()">LÆ°u ID Apple</button>
  <button onclick="clearIdApple()">XoÃ¡ ID Apple</button>
  <div>ID Apple: <span id="displayIdApple">-</span> <button onclick="copyText('displayIdApple')">Copy</button></div>
  <div>Máº­t kháº©u ID Apple: <span id="displayIdApplePass">-</span> <button onclick="copyText('displayIdApplePass')">Copy</button></div>

  <!-- XoÃ¡ toÃ n bá»™ -->
  <button onclick="deleteAllAccounts()">ğŸ—‘ï¸ XoÃ¡ toÃ n bá»™ dá»¯ liá»‡u</button>

  <!-- Firebase Config + Script -->
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7abH9ttrzdGHEs3UoRKnrNKamO-s8K9Q",
    authDomain: "hoangcoka123-7bb54.firebaseapp.com",
    projectId: "hoangcoka123-7bb54",
    storageBucket: "hoangcoka123-7bb54.appspot.com",
    messagingSenderId: "615010120621",
    appId: "1:615010120621:web:3c55dcbf857d4e826f2724"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let accounts = {};
  let filterCopied = false;

  function parseLine(line) {
    return line.includes(':') ? line.split(':') : line.includes('|') ? line.split('|') : line.trim().split(/\s+/);
  }

  document.getElementById("txtUpload").addEventListener("change", function(e) {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = e => {
      const lines = e.target.result.trim().split("\n");
      db.ref("accounts").once("value", snap => {
        const existing = snap.val() || {};
        const existingKeys = new Set(Object.values(existing).map(acc => `${acc.username}|${acc.password}|${acc.email}`));
        let addedCount = 0;
        lines.forEach(line => {
          const p = parseLine(line);
          const key = `${p[0]}|${p[1]}|${p[2]}`;
          if (p.length >= 4 && !existingKeys.has(key)) {
            db.ref("accounts").push({
              username: p[0], password: p[1], email: p[2], emailPass: p[3], copied: false
            });
            addedCount++;
          }
        });
        alert(`âœ… ÄÃ£ nháº­p tá»« TXT thÃ nh cÃ´ng!\nTá»•ng sá»‘ dÃ²ng Ä‘Ã£ thÃªm: ${addedCount}`);
        filterCopied = false;
        setTimeout(() => {
          renderAccounts();
          updateStats();
        }, 1000);
      });
    };
    r.readAsText(f);
  });

  function renderAccounts() {
    const unused = Object.entries(accounts).filter(([_, acc]) => !acc.copied);
    const random = unused[Math.floor(Math.random() * unused.length)];
    if (!random) return;
    const acc = random[1];
    document.getElementById("lastUsername").textContent = acc.username;
    document.getElementById("lastPassword").textContent = acc.password;
    document.getElementById("lastEmail").textContent = acc.email;
    document.getElementById("lastEmailPass").textContent = acc.emailPass;
  }

  function exportClipboardContent() {
  const content = document.getElementById("pasteArea").value;
  const blob = new Blob([content], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clipboard_export.txt";
  a.click();
}

function updateStats() {
    const all = Object.values(accounts);
    const used = all.filter(a => a.copied).length;
    const unused = all.length - used;
    console.log(`ğŸ“Š ÄÃ£ dÃ¹ng: ${used}, ChÆ°a dÃ¹ng: ${unused}`);
  }

  db.ref("accounts").on("value", snap => {
    accounts = snap.val() || {};
    if (!filterCopied) renderAccounts();
    updateStats();
  });
  fetchGlobalIdApple();

  function pasteFromClipboard() {
    document.getElementById("clipboardResult").innerText = "";
    navigator.clipboard.readText().then(text => {
      const lines = text.trim().split("\n");
      document.getElementById("pasteArea").value = text;
      db.ref("accounts").once("value", snap => {
        const existing = snap.val() || {};
        const existingKeys = new Set(Object.values(existing).map(acc => `${acc.username}|${acc.password}|${acc.email}`));
        let addedCount = 0;
        lines.forEach(line => {
          const p = parseLine(line);
          const key = `${p[0]}|${p[1]}|${p[2]}`;
          if (p.length >= 4 && !existingKeys.has(key)) {
            db.ref("accounts").push({
              username: p[0], password: p[1], email: p[2], emailPass: p[3], copied: false
            });
            addedCount++;
          }
        });
        document.getElementById("clipboardResult").innerText = `âœ… ÄÃ£ dÃ¡n tá»« Clipboard thÃ nh cÃ´ng!
Tá»•ng sá»‘ dÃ²ng Ä‘Ã£ thÃªm: ${addedCount}`;
        filterCopied = false;
        setTimeout(() => {
          renderAccounts();
          updateStats();
        }, 1000);
      });
    });
  }
  </script>
<!-- Hiá»ƒn thá»‹ thá»‘ng kÃª ngay trÃªn trang -->
  <div style="margin-top:20px">
    <strong>ğŸ“Š Thá»‘ng kÃª:</strong>
    <span id="usedCount">ÄÃ£ dÃ¹ng: 0</span> | <span id="unusedCount">ChÆ°a dÃ¹ng: 0</span>
  </div>

  <script>
    function updateStats() {
      const all = Object.values(accounts);
      const used = all.filter(a => a.copied).length;
      const unused = all.length - used;
      document.getElementById("usedCount").textContent = `ÄÃ£ dÃ¹ng: ${used}`;
      document.getElementById("unusedCount").textContent = `ChÆ°a dÃ¹ng: ${unused}`;
      console.log(`ğŸ“Š ÄÃ£ dÃ¹ng: ${used}, ChÆ°a dÃ¹ng: ${unused}`);
    }
  </script>
</body>
</html>
